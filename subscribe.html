<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPS2Quantum™ Workbench — Subscribe</title>

  <script>
  (function () {
    const href = String(location.href || "");
    const ref  = String(document.referrer || "");
    const inBuilderPreview =
      href.startsWith("about:srcdoc") || /godaddy|myftpupload|gdiframe|pagebuilder/i.test(ref);
    if (!inBuilderPreview && window.top !== window.self) {
      try { window.top.location.replace(window.location.href); } catch (_) {}
    }
  })();
  </script>

  <style>
    :root{ --bg:#0f1419; --panel:#121a22; --ink:#e8f0f7; --muted:#9fb2c7; --brand:#ff4d3d; --brand2:#2aa6ff; --ok:#17c964; --border:#1f2a35; }
    html,body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;overflow-x:hidden}
    .wrap{max-width:1100px;margin:0 auto;padding:28px 18px 60px;min-height:100vh}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}.logo .dot{color:var(--brand)}
    .nav a{color:var(--muted);text-decoration:none;margin-left:16px}
    .hero{background:linear-gradient(135deg, #0d1721, #0a1a26 55%, #0a1520);border:1px solid var(--border);border-radius:16px;padding:28px;margin:10px 0 26px}
    h1{margin:0 0 .25rem;font-size:28px}.sub{color:var(--muted);margin:0}
    .cta{display:flex;flex-wrap:wrap;gap:12px;margin-top:16px}
    .cta a{background:var(--brand2);color:#07131b;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:700}
    .cta a.secondary{background:#1b2834;color:var(--ink);border:1px solid var(--border)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:18px}
    .plan{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .name{font-weight:700}.price{font-weight:800}.muted{color:var(--muted)}
    .features{margin:12px 0 18px;padding-left:18px}.features li{margin:6px 0}
    .btn{display:inline-block;background:var(--brand);color:#120b0b;text-decoration:none;padding:10px 14px;border-radius:10px;font-weight:800;cursor:pointer;border:none;width:100%;text-align:center;transition:all 0.2s ease;position:relative}
    .btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
    .btn.ghost{background:#0e171f;border:1px solid var(--border);color:var(--ink)}
    .foot{margin-top:28px;font-size:14px;color:var(--muted);text-align:center}
    .kicker{font-size:12px;color:var(--muted);margin-top:8px}
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .status-msg {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 16px;
      border-radius: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--ink);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    
    .status-msg.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .status-msg.error {
      border-color: var(--brand);
      background: #2a1a19;
    }
    
    .status-msg.success {
      border-color: var(--ok);
      background: #1a2a1f;
    }
  </style>
</head>
<body>
  <div id="statusMsg" class="status-msg"></div>

  <div class="wrap">

    <header>
      <div class="logo" aria-label="GPS2Quantum"><span>GPS<span class="dot">2</span>Quantum™</span></div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/#platform">Platform</a>
        <a href="https://greggillan9.github.io/gps2quantum-login/" class="login" rel="noopener">Login</a>
        <a href="https://billing.stripe.com/p/login/4gMcN6cYue972Pb3p92wU00" rel="noopener">Billing Portal</a>
      </nav>
    </header>

    <section class="hero">
      <h1>Subscribe to GPS2Quantum™ Workbench</h1>
      <p class="sub">Professional coordinate conversion & quantum drift simulation for engineers, researchers, analysts and academics.</p>
      <div class="cta">
        <a href="https://greggillan9.github.io/gps2quantum-login/" rel="noopener">Login to Workbench</a>
        <a href="https://billing.stripe.com/p/login/4gMcN6cYue972Pb3p92wU00" class="secondary" rel="noopener">Manage billing</a>
      </div>
      <p class="kicker">Already purchased? Use <b>Login</b>. Need to update payment or cancel? Use <b>Manage billing</b>.</p>
    </section>

    <!-- Monthly -->
    <h2 style="margin:10px 4px">Monthly plans</h2>
    <section class="grid" aria-label="Monthly pricing">
      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Pro Monthly</div>
            <div class="muted">1 seat • full Workbench</div>
          </div>
          <div class="price">$49<span class="muted">/mo</span></div>
        </div>
        <ul class="features">
          <li>All coordinate formats (DD,DDM,DMS,UTM,MGRS,SPCS,ECEF,ENU)</li>
          <li>Quantum drift modeling (Δt, Δs, Δr)</li>
          <li>Map with GPS and Quantum detail</li>
          <li>GreenScreen + PunchCard presentations</li>
        </ul>
        <button class="btn" data-price="price_1RvlrPJp0xGVpVuS4yw75oQc" data-qty="1">
          Subscribe monthly
        </button>
      </div>

      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Academic/Student Monthly</div>
            <div class="muted">1 seat • full Workbench</div>
          </div>
          <div class="price">$19<span class="muted">/mo</span></div>
        </div>
        <ul class="features">
          <li>All coordinate formats (DD,DDM,DMS,UTM,MGRS,SPCS,ECEF,ENU)</li>
          <li>Quantum drift modeling (Δt, Δs, Δr)</li>
          <li>Map with GPS and Quantum detail</li>
          <li>GreenScreen + PunchCard presentations</li>
        </ul>
        <button class="btn" data-price="price_1Rvm1XJp0xGVpVuSCJLFYnA5" data-qty="1">
          Subscribe monthly
        </button>
      </div>

      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Enterprise Monthly</div>
            <div class="muted">5 seats* • full Workbench</div>
          </div>
          <div class="price">$99<span class="muted">/mo</span></div>
        </div>
        <ul class="features">
          <li>All coordinate formats (DD,DDM,DMS,UTM,MGRS,SPCS,ECEF,ENU)</li>
          <li>Quantum drift modeling (Δt, Δs, Δr)</li>
          <li>Map with GPS and Quantum detail</li>
          <li>GreenScreen + PunchCard presentations</li>
        </ul>
        <button class="btn" data-price="price_1Rvlz3Jp0xGVpVuSESG2QQhF" data-qty="5">
          Subscribe monthly
        </button>
        <div class="kicker">*contact us for optional license terms.</div>
      </div>
    </section>

    <!-- Annual -->
    <h2 style="margin:24px 4px 10px">Annual plans</h2>
    <section class="grid" aria-label="Annual pricing">
      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Pro Annual</div>
            <div class="muted">1 seat • full Workbench</div>
          </div>
          <div class="price">$294<span class="muted">/yr</span></div>
        </div>
        <ul class="features"><li>All features, billed yearly</li><li>Save $294 vs monthly</li></ul>
        <button class="btn" data-price="price_1S3fPjJp0xGVpVuSLjifRqMH" data-qty="1">
          Subscribe annually
        </button>
      </div>

      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Academic/Student Annual</div>
            <div class="muted">1 seat • full Workbench</div>
          </div>
          <div class="price">$114<span class="muted">/yr</span></div>
        </div>
        <ul class="features"><li>All features, billed yearly</li><li>Save $114 vs monthly</li></ul>
        <button class="btn" data-price="price_1S3fJYJp0xGVpVuSE6q5zndK" data-qty="1">
          Subscribe annually
        </button>
      </div>

      <div class="card">
        <div class="plan">
          <div>
            <div class="name">Enterprise Annual</div>
            <div class="muted">5 seats* • full Workbench</div>
          </div>
          <div class="price">$594<span class="muted">/yr</span></div>
        </div>
        <ul class="features"><li>All features, billed yearly</li><li>Save $594 vs monthly</li></ul>
        <button class="btn" data-price="price_1S3fN8Jp0xGVpVuSKeAsFpjt" data-qty="5">
          Subscribe annually
        </button>
        <div class="kicker">*contact us for optional license terms.</div>
      </div>
    </section>

    <p class="foot">Questions? <a href="/#contact" style="color:var(--brand2)">Contact us</a> • <a href="/privacy" style="color:var(--brand2)">Privacy</a> • <a href="/terms" style="color:var(--brand2)">Terms</a></p>
  </div>

  <script>
  (function () {
    const BACKEND_BASE = "https://gps2quantum-backend-506830622318.us-central1.run.app";
    const LOGIN_PAGE   = "https://greggillan9.github.io/gps2quantum-login/";

    // Status messaging system
    function showStatus(message, type = 'info') {
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.textContent = message;
      statusMsg.className = `status-msg ${type} show`;
      
      setTimeout(() => {
        statusMsg.classList.remove('show');
      }, type === 'error' ? 5000 : 3000);
    }

    // Token management with better error handling
    function getIdToken() {
      try {
        return sessionStorage.getItem("gps2q_idtoken") || localStorage.getItem("gps2q_idtoken") || "";
      } catch (e) {
        console.warn("Failed to get token:", e);
        return "";
      }
    }

    function setButtonLoading(button, loading) {
      if (loading) {
        button.disabled = true;
        button.dataset.originalText = button.textContent;
        button.innerHTML = '<span class="loading"></span>Processing...';
      } else {
        button.disabled = false;
        button.textContent = button.dataset.originalText || button.textContent.replace('Processing...', '').trim();
      }
    }

    async function startCheckout(priceId, quantity = 1) {
      if (!priceId) {
        showStatus("Missing price ID", "error");
        return;
      }

      // Find the button that triggered this
      const button = document.querySelector(`[data-price="${priceId}"]`);
      if (!button) {
        showStatus("Button not found", "error");
        return;
      }

      setButtonLoading(button, true);
      showStatus("Starting checkout...", "info");

      try {
        const token = getIdToken();
        const headers = {
          "Content-Type": "application/json",
          "Accept": "application/json"
        };
        
        if (token) {
          headers.Authorization = "Bearer " + token;
        }

        const response = await fetch(`${BACKEND_BASE}/create-checkout-session`, {
          method: "POST",
          credentials: "include",
          headers,
          body: JSON.stringify({ 
            priceId, 
            quantity: Number(quantity || 1) 
          })
        });

        // Handle authentication required
        if (response.status === 401) {
          showStatus("Please log in to continue", "error");
          setTimeout(() => {
            window.location.href = LOGIN_PAGE;
          }, 1500);
          return;
        }

        let data;
        try {
          data = await response.json();
        } catch (e) {
          data = {};
        }

        if (response.ok && data.url) {
          showStatus("Redirecting to checkout...", "success");
          window.location.href = data.url;
        } else {
          const errorMsg = data.error || 
                          (response.status === 403 ? "Access denied" : 
                           response.status === 429 ? "Too many requests, please wait" :
                           response.status === 500 ? "Server error, please try again" :
                           `Checkout failed (${response.status})`);
          
          showStatus(errorMsg, "error");
          console.error("Checkout error:", {
            status: response.status,
            data,
            priceId,
            quantity
          });
        }
      } catch (error) {
        console.error("Network error:", error);
        const errorMsg = error.name === 'TypeError' && error.message.includes('fetch') 
          ? "Network connection failed. Please check your internet and try again."
          : error.message || "An unexpected error occurred";
        
        showStatus(errorMsg, "error");
      } finally {
        setButtonLoading(button, false);
      }
    }

    // Make function available globally
    window.startCheckout = startCheckout;
    
    // Also make it available to parent window if in iframe
    try {
      if (window.top && window.top !== window && !window.top.startCheckout) {
        window.top.startCheckout = startCheckout;
      }
    } catch (e) {
      // Ignore cross-origin errors
    }

    function wireButtons() {
      document.querySelectorAll("[data-price]").forEach((button) => {
        if (button.__gps2qWired) return;
        
        button.addEventListener("click", (e) => {
          e.preventDefault();
          const priceId = button.getAttribute("data-price");
          const quantity = button.getAttribute("data-qty") || "1";
          startCheckout(priceId, quantity);
        });
        
        button.__gps2qWired = true;
      });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener("DOMContentLoaded", wireButtons);
    } else {
      wireButtons();
    }

    // Also wire buttons if they're added dynamically
    const observer = new MutationObserver(() => {
      wireButtons();
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });

  })();
  </script>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GPS2Quantum™ — Workbench Login</title>
  <style>
    :root {
      --bg:#0e1217; --panel:#141a22; --text:#e8eef6; --muted:#a9b4c3;
      --accent:#f0544f; --accent2:#2eaadc; --ok:#2ecc71; --err:#e74c3c;
      --input:#0f141b; --border:#232d3a;
    }

    html, body {
      margin: 0;
      height: auto;
      min-height: 100%;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;
      overflow-y: auto;
      overflow-x: hidden;
      overscroll-behavior: contain;
    }

    .wrap{
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 24px;
    }

    .card{
      width:100%;
      max-width:440px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:22px 22px 18px;
      box-shadow:0 12px 30px rgba(0,0,0,.35)
    }

    h1{margin:0 0 8px;font-size:22px;font-weight:700;letter-spacing:.2px}
    .sub{margin:0 0 18px;font-size:13px;color:var(--muted)}
    label{display:block;font-size:13px;margin:12px 0 6px}
    input[type=email],input[type=password]{
      width:100%;background:var(--input);border:1px solid var(--border);
      color:var(--text);border-radius:10px;padding:12px 12px;outline:none;
      box-sizing:border-box;
    }
    input:focus{border-color:#395274;box-shadow:0 0 0 3px rgba(46,170,220,.15)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .btn{appearance:none;border:none;border-radius:12px;cursor:pointer;padding:12px 14px;font-weight:700;letter-spacing:.2px;transition:.15s all;position:relative;}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .btn-primary{background:var(--accent);color:white}.btn-primary:hover:not(:disabled){filter:brightness(1.05)}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-ghost:hover:not(:disabled){border-color:#3a4658}
    .btn-google{background:white;color:#1a1f27;border:1px solid #e6e6e6}
    .hr{height:1px;background:#1f2733;margin:16px 0}
    .muted{color:var(--muted)} .link{color:var(--accent2);text-decoration:none}
    .msg{margin:8px 0 0;font-size:13px;min-height:18px}.msg.ok{color:var(--ok)}.msg.err{color:var(--err)}
    .foot{margin-top:16px;font-size:12px;color:var(--muted);text-align:center}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
    .logo{width:28px;height:28px;border-radius:8px;background:#1c2430;display:grid;place-items:center;font-weight:900}
    .row .btn{flex:1}
    
    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top: 2px solid currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand"><div class="logo">Q</div><div style="font-weight:800;letter-spacing:.3px;">GPS2Quantum™</div></div>
      <h1>Login to Workbench</h1>
      <p class="sub">Use your email and password (or Google) to access the GPS2Quantum™ Workbench.</p>

      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="email" placeholder="you@company.com" />

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />

      <div class="row" style="margin-top:14px">
        <button class="btn btn-primary" id="btnSignIn">Sign in</button>
        <button class="btn btn-ghost" id="btnSignUp">Create account</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn btn-google" id="btnGoogle">
          <span style="display:inline-flex;gap:8px;align-items:center;justify-content:center">
            <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.6 20.5H42V20H24v8h11.3C33.9 32.6 29.5 36 24 36c-6.6 0-12-5.4-12-12s5.4-12 12-12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.4 6.1 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10.4 0 19-8.4 19-19 0-1.3-.1-2.2-.4-3.5z"/><path fill="#FF3D00" d="M6.3 14.7l6.6 4.8C14.4 16.7 18.8 14 24 14c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.4 6.1 29.5 4 24 4 16 4 9.1 8.6 6.3 14.7z"/><path fill="#4CAF50" d="M24 44c5.4 0 10.3-2.1 13.9-5.6l-6.4-5.2C29.4 34.8 26.9 36 24 36c-5.5 0-9.9-3.4-11.6-8.1l-6.5 5C8.8 39.2 15.9 44 24 44z"/><path fill="#1976D2" d="M43.6 20.5H42V20H24v8h11.3c-1.3 3.7-5.7 8.2-11.3 8.2-6.6 0-12-5.4-12-12S17.4 12 24 12c3.1 0 5.9 1.2 8 3.1l5.7-5.7C34.4 6.1 29.5 4 24 4 12.9 4 4 12.9 4 24s8.9 20 20 20c10.4 0 19-8.4 19-19 0-1.3-.1-2.2-.4-3.5z"/></svg>
            <span>Sign in with Google</span>
          </span>
        </button>
      </div>

      <div class="row" style="margin-top:8px">
        <a href="#" class="link" id="linkReset">Forgot password?</a><div></div>
      </div>

      <div id="msg" class="msg"></div>

      <div class="hr"></div>
      <p class="foot">Having trouble? <a class="link" href="mailto:support@gps2quantum.com">Contact support</a></p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth, setPersistence, browserLocalPersistence,
      signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, signInWithPopup, GoogleAuthProvider
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyB_RuCtCsxbNYDv-LE7SVF_0FiU4VjwQME",
      authDomain: "gps2quantum-prod-platform.firebaseapp.com",
      projectId: "gps2quantum-prod-platform",
      storageBucket: "gps2quantum-prod-platform.firebasestorage.app",
      messagingSenderId: "506830622318",
      appId: "1:506830622318:web:8982f1557a93a3ea7b207f",
      measurementId: "G-V4H4X9KB78"
    };

    const BACKEND_ROOT = "https://gps2quantum-backend-506830622318.us-central1.run.app/";
    const SESSION_LOGIN_URL = BACKEND_ROOT + "sessionLogin";

    const app = initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    
    setPersistence(auth, browserLocalPersistence).catch(console.warn);

    const $ = (id) => document.getElementById(id);
    const emailEl = $("email");
    const passEl = $("password");
    const msgEl = $("msg");
    
    const setLoading = (btn, loading) => {
      if (loading) {
        btn.disabled = true;
        btn.dataset.original = btn.textContent;
        btn.innerHTML = '<span class="loading"></span>' + btn.textContent;
      } else {
        btn.disabled = false;
        btn.textContent = btn.dataset.original || btn.textContent.replace('...', '');
      }
    };

    const ok = (t) => { msgEl.textContent = t; msgEl.className = "msg ok"; };
    const err = (t) => { msgEl.textContent = t; msgEl.className = "msg err"; };
    const info = (t) => { msgEl.textContent = t; msgEl.className = "msg muted"; };

    const storeToken = (token) => {
      try {
        sessionStorage.setItem("gps2q_idtoken", token);
        localStorage.setItem("gps2q_idtoken", token);
        console.log("Token stored successfully");
      } catch (e) {
        console.warn("Failed to store token:", e);
      }
    };

    async function setCookieAndGo(idToken) {
      // Store token first (primary auth method)
      storeToken(idToken);
      
      // Still try to set backend cookie for same-origin requests, but don't depend on it
      try {
        const response = await fetch(SESSION_LOGIN_URL, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          credentials: "include",
          body: JSON.stringify({ idToken })
        });

        if (!response.ok) {
          console.warn("Cookie set failed, using token-based auth");
        } else {
          console.log("Cookie set successfully");
        }
      } catch (e) {
        console.warn("Cookie request failed, using token-based auth:", e);
      }

      // Redirect to backend regardless of cookie success
      window.location.replace(BACKEND_ROOT);
    }

    async function postLogin(user) {
      try {
        info("Setting up session...");
        const idToken = await user.getIdToken(true);
        await setCookieAndGo(idToken);
        ok("Success! Redirecting...");
      } catch (e) {
        console.error("Post-login error:", e);
        err(e.message || "Login failed");
      }
    }

    $("btnSignIn").addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      
      if (!email || !password) {
        err("Please enter both email and password");
        return;
      }

      const btn = $("btnSignIn");
      setLoading(btn, true);
      info("Signing in...");
      
      try {
        const { user } = await signInWithEmailAndPassword(auth, email, password);
        await postLogin(user);
      } catch (e) {
        console.error("Sign in error:", e);
        err(e.message || "Sign in failed");
        setLoading(btn, false);
      }
    });

    $("btnSignUp").addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      
      if (!email || !password) {
        err("Please enter both email and password");
        return;
      }

      if (password.length < 6) {
        err("Password must be at least 6 characters");
        return;
      }

      const btn = $("btnSignUp");
      setLoading(btn, true);
      info("Creating account...");
      
      try {
        const { user } = await createUserWithEmailAndPassword(auth, email, password);
        await postLogin(user);
      } catch (e) {
        console.error("Sign up error:", e);
        err(e.message || "Account creation failed");
        setLoading(btn, false);
      }
    });

    $("btnGoogle").addEventListener("click", async () => {
      const btn = $("btnGoogle");
      setLoading(btn, true);
      info("Authenticating with Google...");
      
      try {
        const provider = new GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        const { user } = await signInWithPopup(auth, provider);
        await postLogin(user);
      } catch (e) {
        console.error("Google auth error:", e);
        if (e.code !== 'auth/popup-closed-by-user') {
          err(e.message || "Google authentication failed");
        }
        setLoading(btn, false);
      }
    });

    $("linkReset").addEventListener("click", async (ev) => {
      ev.preventDefault();
      const email = emailEl.value.trim();
      
      if (!email) {
        err("Enter your email first");
        return;
      }

      info("Sending reset email...");
      
      try {
        await sendPasswordReresetEmail(auth, email);
        ok("Password reset email sent");
      } catch (e) {
        console.error("Password reset error:", e);
        err(e.message || "Failed to send reset email");
      }
    });

    [emailEl, passEl].forEach(input => {
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          $("btnSignIn").click();
        }
      });
    });
  </script>
</body>
</html>